// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// NIST 800-171 Controls
// ============================================================================

model Control {
  id                     Int      @id @default(autoincrement())
  controlId              String   @unique @map("control_id") // Format: "03.01.01" for Rev 3
  family                 String // AC|AT|AU|CA|CM|CP|IA|IR|MA|MP|PE|PS|RA|SA|SC|SI|SR|PL
  title                  String
  requirementText        String   @map("requirement_text")
  discussionText         String?  @map("discussion_text")
  references             String?  @map("references") // Full references text
  sourceControls         String?  @map("source_controls") // JSON array of source control IDs
  supportingPublications String?  @map("supporting_publications") // JSON array of supporting publications
  priority               String   @default("Medium") // Critical, High, Medium, Low
  revision               String   @default("3") // NIST 800-171 Revision number
  publicationDate        String   @default("May 2024") @map("publication_date") // Publication date
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  status          ControlStatus?
  assessments     Assessment[]
  evidence        Evidence[]
  poams           Poam[]
  changeHistory   ChangeHistory[]
  gaps            ControlGap[]
  poamItems       POAMItem[]
  coverage        ControlCoverage?
  controlEvidence ControlEvidence[]
  settingMappings ControlSettingMapping[]
  m365Compliance  ControlM365Compliance?
  improvementActionMappings ImprovementActionMapping[]

  @@index([family])
  @@index([priority])
  @@index([revision])
  @@map("controls")
}

// ============================================================================
// Control Implementation Status
// ============================================================================

model ControlStatus {
  id                  Int       @id @default(autoincrement())
  controlId           Int       @unique @map("control_id")
  status              String    @default("Not Started") // Not Started, In Progress, Implemented, Verified
  implementationDate  DateTime? @map("implementation_date")
  lastReviewedDate    DateTime? @map("last_reviewed_date")
  nextReviewDate      DateTime? @map("next_review_date")
  assignedTo          String?   @map("assigned_to")
  implementationNotes String?   @map("implementation_notes")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("control_status")
}

// ============================================================================
// Compliance Assessments
// ============================================================================

model Assessment {
  id               Int      @id @default(autoincrement())
  controlId        Int      @map("control_id")
  assessmentDate   DateTime @map("assessment_date")
  isImplemented    Boolean  @default(false) @map("is_implemented")
  hasEvidence      Boolean  @default(false) @map("has_evidence")
  isTested         Boolean  @default(false) @map("is_tested")
  meetsRequirement Boolean  @default(false) @map("meets_requirement")
  riskScore        Int      @default(0) @map("risk_score") // 0-100
  assessorNotes    String?  @map("assessor_notes")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

// ============================================================================
// Evidence Files
// ============================================================================

model Evidence {
  id           Int      @id @default(autoincrement())
  controlId    Int      @map("control_id")
  fileName     String   @map("file_name") // Stored file name (sanitized + timestamp)
  originalName String   @map("original_name") // Original uploaded file name
  filePath     String   @map("file_path") // Relative path from uploads directory
  fileType     String   @map("file_type") // MIME type (application/pdf, image/png, etc.)
  fileSize     Int      @map("file_size") // Size in bytes
  description  String? // Optional user description
  uploadedBy   String?  @map("uploaded_by") // User who uploaded (optional for single-user app)
  uploadedDate DateTime @default(now()) @map("uploaded_date")
  version      Int      @default(1)
  tags         String? // JSON array stored as string: ["policy", "audit"]
  isArchived   Boolean  @default(false) @map("is_archived")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([controlId])
  @@index([uploadedDate])
  @@index([fileType])
  @@map("evidence")
}

// ============================================================================
// POAMs (Plan of Action & Milestones)
// ============================================================================

model Poam {
  id                   Int       @id @default(autoincrement())
  controlId            Int       @map("control_id")
  gapDescription       String    @map("gap_description")
  remediationPlan      String    @map("remediation_plan")
  assignedTo           String?
  priority             String    @default("Medium") // High, Medium, Low
  status               String    @default("Open") // Open, In Progress, Completed, Risk Accepted
  startDate            DateTime? @map("start_date")
  targetCompletionDate DateTime? @map("target_completion_date")
  actualCompletionDate DateTime? @map("actual_completion_date")
  resourcesRequired    String?   @map("resources_required")
  budgetEstimate       Float?    @map("budget_estimate")
  riskAcceptanceNotes  String?   @map("risk_acceptance_notes")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  control    Control         @relation(fields: [controlId], references: [id], onDelete: Cascade)
  milestones PoamMilestone[]

  @@index([controlId])
  @@index([status])
  @@index([priority])
  @@map("poams")
}

// ============================================================================
// POAM Milestones
// ============================================================================

model PoamMilestone {
  id                   Int       @id @default(autoincrement())
  poamId               Int       @map("poam_id")
  milestoneDescription String    @map("milestone_description")
  dueDate              DateTime  @map("due_date")
  completionDate       DateTime? @map("completion_date")
  status               String    @default("Pending") // Pending, In Progress, Completed
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  poam Poam @relation(fields: [poamId], references: [id], onDelete: Cascade)

  @@index([poamId])
  @@index([status])
  @@map("poam_milestones")
}

// ============================================================================
// Microsoft 365 Policies
// ============================================================================

model M365Policy {
  id                Int      @id @default(autoincrement())
  policyType        String   @map("policy_type") // 'Intune' | 'Purview' | 'AzureAD' | 'Defender'
  policyId          String   @unique @map("policy_id") // External ID from M365
  policyName        String   @map("policy_name")
  policyDescription String?  @map("policy_description")
  policyData        String   @map("policy_data") // JSON string of full policy object
  lastSynced        DateTime @default(now()) @map("last_synced")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // === NEW FIELDS FOR HYBRID APPROACH ===
  // Extracted from policyData["@odata.type"] for easy filtering
  odataType              String?   @map("odata_type") // e.g., "#microsoft.graph.windowsUpdateForBusinessConfiguration"

  // High-level grouping (derived from odataType)
  templateFamily         String?   @map("template_family") // e.g., "Update", "Compliance", "AppProtection", "Configuration"

  // Cache of all extractable properties (for quick lookups)
  extractedProperties    String?   @map("extracted_properties") // JSON: {"automaticUpdateMode": "autoInstall", ...}
  propertiesLastExtracted DateTime? @map("properties_last_extracted")

  complianceChecks  SettingComplianceCheck[]

  // === NEW INDEXES FOR PERFORMANCE ===
  @@index([odataType])
  @@index([templateFamily])
  @@index([policyType, odataType])
  @@map("m365_policies")
}

// ============================================================================
// Control to M365 Policy Mappings
// ============================================================================

// REMOVED: ControlPolicyMapping model
// This model mapped M365 policies to NIST controls
// Removed as part of policy mapping refactor

// ============================================================================
// M365 Integration Settings
// ============================================================================

model M365Settings {
  id               Int       @id @default(autoincrement())
  tenantId         String?   @map("tenant_id")
  clientId         String?   @map("client_id")
  lastSyncDate     DateTime? @map("last_sync_date")
  syncEnabled      Boolean   @default(false) @map("sync_enabled")
  autoSyncInterval Int       @default(24) @map("auto_sync_interval") // hours
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("m365_settings")
}

// ============================================================================
// Sync History Log
// ============================================================================

model M365SyncLog {
  id                    Int      @id @default(autoincrement())
  syncDate              DateTime @default(now()) @map("sync_date")
  syncType              String   @map("sync_type") // 'Manual' | 'Automatic'
  policiesUpdated       Int      @default(0) @map("policies_updated")
  controlsUpdated       Int      @default(0) @map("controls_updated")
  status                String   @map("status") // 'Success' | 'Failed' | 'Partial'
  errorMessage          String?  @map("error_message")
  syncDuration          Int?     @map("sync_duration") // milliseconds

  // Compliance tracking fields
  complianceChecked     Boolean  @default(false) @map("compliance_checked")
  settingsValidated     Int      @default(0) @map("settings_validated")
  complianceImproved    Int      @default(0) @map("compliance_improved") // Controls that improved
  complianceDeclined    Int      @default(0) @map("compliance_declined") // Controls that declined
  controlsAffected      Int      @default(0) @map("controls_affected") // Total controls checked
  complianceErrors      String?  @map("compliance_errors") // JSON array of errors

  createdAt             DateTime @default(now()) @map("created_at")

  @@map("m365_sync_logs")
}

// ============================================================================
// M365 Settings Catalog
// ============================================================================

model M365Setting {
  id              Int       @id @default(autoincrement())

  // Setting identification
  settingName     String    @map("setting_name") // e.g., "passwordMinimumLength"
  displayName     String    @map("display_name") // User-friendly name
  settingPath     String    @map("setting_path") // JSON path in policy, e.g., "settings[0].passwordMinimumLength"

  // Policy context
  policyType      String    @map("policy_type") // 'Intune' | 'Purview' | 'AzureAD' | 'Defender'
  policySubType   String?   @map("policy_sub_type") // 'DeviceConfiguration' | 'ConditionalAccess' | etc.
  platform        String    // 'Windows' | 'iOS' | 'Android' | 'All'

  // Validation
  dataType        String    @map("data_type") // 'boolean' | 'integer' | 'string' | 'array' | 'object'
  expectedValue   String    @map("expected_value") // JSON string of expected value
  validationOperator String @map("validation_operator") // '==' | '>=' | '<=' | 'contains' | 'in' | 'matches'

  // Documentation
  description     String
  implementationGuide String? @map("implementation_guide") // How to configure in M365 admin center
  microsoftDocUrl String?     @map("microsoft_doc_url") // Link to Microsoft docs

  // Status
  isActive        Boolean   @default(true) @map("is_active")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // === NEW FIELDS FOR HYBRID APPROACH ===
  // Policy template this setting applies to
  policyTemplate         String?   @map("policy_template") // e.g., "microsoft.graph.windowsUpdateForBusinessConfiguration"
  templateFamily         String?   @map("template_family") // e.g., "Update", "Compliance", "AppProtection"

  // Alternate paths to try during extraction
  pathVariants           String?   @map("path_variants") // JSON array: ["path1", "path2", "path3"]

  // Alternate property names to try during extraction
  alternateNames         String?   @map("alternate_names") // JSON array: ["name1", "name2", "name3"]

  // Extraction strategy hints for optimization
  extractionHints        String?   @map("extraction_hints") // JSON: {"preferredStrategy": "strip-prefix", "notes": "..."}

  // Learning metrics - track extraction success over time
  successfulExtractions  Int       @default(0) @map("successful_extractions")
  failedExtractions      Int       @default(0) @map("failed_extractions")
  lastExtractedValue     String?   @map("last_extracted_value") // For debugging and verification
  lastExtractedAt        DateTime? @map("last_extracted_at")
  lastSuccessfulStrategy String?   @map("last_successful_strategy") // Which strategy worked last time

  controlMappings ControlSettingMapping[]
  complianceChecks SettingComplianceCheck[]

  @@unique([settingPath, policyType, platform])
  @@index([policyType])
  @@index([platform])
  @@index([isActive])
  // === NEW INDEXES FOR PERFORMANCE ===
  @@index([policyTemplate])
  @@index([templateFamily])
  @@index([policyType, policyTemplate])
  @@map("m365_setting_catalog")
}

// ============================================================================
// Control to M365 Setting Mappings (Many-to-Many)
// ============================================================================

model ControlSettingMapping {
  id              Int       @id @default(autoincrement())
  controlId       Int       @map("control_id") // FK to Control
  settingId       Int       @map("setting_id") // FK to M365Setting

  // Confidence & compliance
  confidence      String    // 'High' | 'Medium' | 'Low'
  isRequired      Boolean   @default(true) @map("is_required") // Required vs optional
  complianceStatus String   @default("Not Configured") @map("compliance_status") // 'Compliant' | 'Non-Compliant' | 'Not Configured'

  // Metadata
  mappingRationale String?  @map("mapping_rationale") // Why this setting satisfies the control
  nistRequirement  String?  @map("nist_requirement") // Specific NIST requirement text

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  control         Control   @relation(fields: [controlId], references: [id], onDelete: Cascade)
  setting         M365Setting @relation(fields: [settingId], references: [id], onDelete: Cascade)

  @@unique([controlId, settingId])
  @@index([controlId])
  @@index([settingId])
  @@index([confidence])
  @@index([complianceStatus])
  @@map("control_setting_mappings")
}

// ============================================================================
// Setting Compliance Checks (Validation Results)
// ============================================================================

model SettingComplianceCheck {
  id              Int       @id @default(autoincrement())

  settingId       Int       @map("setting_id") // FK to M365Setting
  policyId        Int       @map("policy_id") // FK to M365Policy

  // Compliance result
  actualValue     String?   @map("actual_value") // JSON string of actual value found
  expectedValue   String    @map("expected_value") // JSON string of expected value
  isCompliant     Boolean   @map("is_compliant")
  complianceMessage String? @map("compliance_message") // Details about compliance status

  // Metadata
  lastChecked     DateTime  @default(now()) @map("last_checked")

  setting         M365Setting @relation(fields: [settingId], references: [id], onDelete: Cascade)
  policy          M365Policy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([settingId, policyId])
  @@index([settingId])
  @@index([policyId])
  @@index([isCompliant])
  @@index([lastChecked])
  @@map("setting_compliance_checks")
}

// ============================================================================
// Control M365 Compliance Summary (Cached Calculations)
// ============================================================================

model ControlM365Compliance {
  id                    Int       @id @default(autoincrement())
  controlId             Int       @unique @map("control_id") // FK to Control

  // Compliance metrics
  totalRequiredSettings Int       @default(0) @map("total_required_settings")
  compliantSettings     Int       @default(0) @map("compliant_settings")
  nonCompliantSettings  Int       @default(0) @map("non_compliant_settings")
  notConfiguredSettings Int       @default(0) @map("not_configured_settings")
  compliancePercentage  Float     @default(0.0) @map("compliance_percentage") // 0-100

  // Confidence breakdown
  highConfidenceCount   Int       @default(0) @map("high_confidence_count")
  mediumConfidenceCount Int       @default(0) @map("medium_confidence_count")
  lowConfidenceCount    Int       @default(0) @map("low_confidence_count")

  // Platform coverage
  windowsCoverage       Float     @default(0.0) @map("windows_coverage")
  iosCoverage          Float     @default(0.0) @map("ios_coverage")
  androidCoverage      Float     @default(0.0) @map("android_coverage")

  lastCalculated        DateTime  @default(now()) @map("last_calculated")

  control               Control   @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@index([compliancePercentage])
  @@index([lastCalculated])
  @@map("control_m365_compliance")
}

// ============================================================================
// Change History / Audit Log
// ============================================================================

model ChangeHistory {
  id           Int      @id @default(autoincrement())
  controlId    Int      @map("control_id")
  fieldChanged String   @map("field_changed")
  oldValue     String?  @map("old_value")
  newValue     String?  @map("new_value")
  changedBy    String?  @map("changed_by") // Made optional for system changes
  changedAt    DateTime @default(now()) @map("changed_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("change_history")
}

// ============================================================================
// Application Settings
// ============================================================================

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String // JSON-encoded value for flexibility
  category  String // m365, organization, preferences, system
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("settings")
}

// ============================================================================
// Report History
// ============================================================================

model ReportHistory {
  id          Int      @id @default(autoincrement())
  reportType  String   @map("report_type")
  reportName  String   @map("report_name")
  format      String
  filePath    String?  @map("file_path")
  fileSize    Int?     @map("file_size")
  filters     String? // JSON string of applied filters
  generatedAt DateTime @default(now()) @map("generated_at")
  generatedBy String?  @map("generated_by")
  status      String   @default("completed")

  @@map("report_history")
}

// ============================================================================
// Report Templates
// ============================================================================

model ReportTemplate {
  id          Int      @id @default(autoincrement())
  name        String
  reportType  String   @map("report_type")
  format      String
  filters     String? // JSON string of report filters
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("report_templates")
}

// ============================================================================
// Gap Analysis Tables
// ============================================================================

// Gap types for each control
model ControlGap {
  id        Int     @id @default(autoincrement())
  controlId Int     @map("control_id")
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Gap categorization
  gapType         String @map("gap_type") // 'technical', 'policy', 'procedure', 'evidence'
  gapTitle        String @map("gap_title")
  gapDescription  String @map("gap_description")
  nistRequirement String @map("nist_requirement")
  severity        String // 'critical', 'high', 'medium', 'low'

  // Remediation
  status              String    @default("open") // 'open', 'in_progress', 'resolved', 'accepted'
  remediationGuidance String    @map("remediation_guidance")
  assignedTo          String?   @map("assigned_to")
  dueDate             DateTime? @map("due_date")
  resolvedDate        DateTime? @map("resolved_date")
  notes               String?

  // Metadata
  source    String   @default("checklist") // 'checklist', 'manual', 'assessment'
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  poamItem POAMItem?

  @@index([controlId])
  @@index([gapType])
  @@index([status])
  @@index([severity])
  @@map("control_gaps")
}

// Plan of Action & Milestones
model POAMItem {
  id        Int     @id @default(autoincrement())
  controlId Int     @map("control_id")
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Link to gap (optional - POA&M can exist without gap)
  gapId Int?        @unique @map("gap_id")
  gap   ControlGap? @relation(fields: [gapId], references: [id])

  // POA&M details
  weakness   String
  riskLevel  String @map("risk_level") // 'critical', 'high', 'medium', 'low'
  likelihood String // 'high', 'medium', 'low'
  impact     String // 'high', 'medium', 'low'

  // Remediation plan
  remediationPlan   String  @map("remediation_plan")
  requiredResources String? @map("required_resources")
  responsibleParty  String  @map("responsible_party")
  milestones        String // JSON array of milestones

  // Tracking
  status         String    @default("open") // 'open', 'in_progress', 'closed'
  targetDate     DateTime  @map("target_date")
  completionDate DateTime? @map("completion_date")

  // Evidence
  evidence String?

  // Metadata
  sourceOfFinding String   @default("internal_assessment") @map("source_of_finding")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([controlId])
  @@index([status])
  @@index([riskLevel])
  @@index([targetDate])
  @@map("poam_items")
}

// Track control coverage metrics
model ControlCoverage {
  id        Int     @id @default(autoincrement())
  controlId Int     @unique @map("control_id")
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Coverage percentages (0-100)
  technicalCoverage  Int @default(0) @map("technical_coverage")
  policyCoverage     Int @default(0) @map("policy_coverage")
  proceduralCoverage Int @default(0) @map("procedural_coverage")
  evidenceCoverage   Int @default(0) @map("evidence_coverage")
  overallCoverage    Int @default(0) @map("overall_coverage")

  // Counts
  totalGaps    Int @default(0) @map("total_gaps")
  criticalGaps Int @default(0) @map("critical_gaps")
  highGaps     Int @default(0) @map("high_gaps")
  mediumGaps   Int @default(0) @map("medium_gaps")
  lowGaps      Int @default(0) @map("low_gaps")

  // Status
  complianceStatus String @default("unknown") @map("compliance_status") // 'compliant', 'partial', 'non_compliant', 'unknown'

  // Timestamps
  lastAssessed DateTime @default(now()) @map("last_assessed")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([complianceStatus])
  @@index([overallCoverage])
  @@map("control_coverage")
}

// Evidence collection tracking
model ControlEvidence {
  id        Int     @id @default(autoincrement())
  controlId Int     @map("control_id")
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Evidence details
  evidenceType        String  @map("evidence_type") // 'policy', 'screenshot', 'log', 'report', 'procedure', 'other'
  evidenceTitle       String  @map("evidence_title")
  evidenceDescription String? @map("evidence_description")

  // File information
  fileName String? @map("file_name")
  filePath String? @map("file_path")
  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")

  // Status
  status     String  @default("required") // 'required', 'uploaded', 'verified', 'rejected'
  uploadedBy String? @map("uploaded_by")
  verifiedBy String? @map("verified_by")

  // Timestamps
  uploadedAt DateTime? @map("uploaded_at")
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@index([controlId])
  @@index([status])
  @@index([evidenceType])
  @@map("control_evidence")
}

// ============================================================================
// Microsoft Improvement Actions (from Compliance Manager)
// ============================================================================

model MicrosoftImprovementAction {
  id          Int      @id @default(autoincrement())
  actionId    String   @unique @map("action_id") // Microsoft's action ID (UUID)
  actionTitle String   @map("action_title")

  // Relationships
  mappings    ImprovementActionMapping[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("microsoft_improvement_actions")
}

model ImprovementActionMapping {
  id               Int      @id @default(autoincrement())

  // Foreign Keys
  controlId        Int      @map("control_id")
  control          Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  actionId         Int      @map("action_id")
  action           MicrosoftImprovementAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  // Mapping Details
  confidence       String   // High, Medium, Low
  coverageLevel    String   @map("coverage_level") // Full, Partial, Supplementary
  isPrimary        Boolean  @map("is_primary")
  mappingRationale String   @map("mapping_rationale")
  nistRequirement  String   @map("nist_requirement")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([controlId, actionId])
  @@index([controlId])
  @@index([actionId])
  @@map("improvement_action_mappings")
}

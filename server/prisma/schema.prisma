// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// NIST 800-171 Controls
// ============================================================================

model Control {
  id                      Int      @id @default(autoincrement())
  controlId               String   @unique @map("control_id") // Format: "03.01.01" for Rev 3
  family                  String // AC|AT|AU|CA|CM|CP|IA|IR|MA|MP|PE|PS|RA|SA|SC|SI|SR|PL
  title                   String
  requirementText         String   @map("requirement_text")
  discussionText          String?  @map("discussion_text")
  references              String?  @map("references") // Full references text
  sourceControls          String?  @map("source_controls") // JSON array of source control IDs
  supportingPublications  String?  @map("supporting_publications") // JSON array of supporting publications
  priority                String   @default("Medium") // Critical, High, Medium, Low
  revision                String   @default("3") // NIST 800-171 Revision number
  publicationDate         String   @default("May 2024") @map("publication_date") // Publication date
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  status         ControlStatus?
  assessments    Assessment[]
  evidence       Evidence[]
  poams          Poam[]
  policyMappings ControlPolicyMapping[]
  changeHistory  ChangeHistory[]
  gaps           ControlGap[]
  poamItems      POAMItem[]
  coverage       ControlCoverage?
  controlEvidence ControlEvidence[]

  @@index([family])
  @@index([priority])
  @@index([revision])
  @@map("controls")
}

// ============================================================================
// Control Implementation Status
// ============================================================================

model ControlStatus {
  id                  Int       @id @default(autoincrement())
  controlId           Int       @unique @map("control_id")
  status              String    @default("Not Started") // Not Started, In Progress, Implemented, Verified
  implementationDate  DateTime? @map("implementation_date")
  lastReviewedDate    DateTime? @map("last_reviewed_date")
  nextReviewDate      DateTime? @map("next_review_date")
  assignedTo          String?   @map("assigned_to")
  implementationNotes String?   @map("implementation_notes")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("control_status")
}

// ============================================================================
// Compliance Assessments
// ============================================================================

model Assessment {
  id               Int      @id @default(autoincrement())
  controlId        Int      @map("control_id")
  assessmentDate   DateTime @map("assessment_date")
  isImplemented    Boolean  @default(false) @map("is_implemented")
  hasEvidence      Boolean  @default(false) @map("has_evidence")
  isTested         Boolean  @default(false) @map("is_tested")
  meetsRequirement Boolean  @default(false) @map("meets_requirement")
  riskScore        Int      @default(0) @map("risk_score") // 0-100
  assessorNotes    String?  @map("assessor_notes")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

// ============================================================================
// Evidence Files
// ============================================================================

model Evidence {
  id           Int      @id @default(autoincrement())
  controlId    Int      @map("control_id")
  fileName     String   @map("file_name") // Stored file name (sanitized + timestamp)
  originalName String   @map("original_name") // Original uploaded file name
  filePath     String   @map("file_path") // Relative path from uploads directory
  fileType     String   @map("file_type") // MIME type (application/pdf, image/png, etc.)
  fileSize     Int      @map("file_size") // Size in bytes
  description  String? // Optional user description
  uploadedBy   String?  @map("uploaded_by") // User who uploaded (optional for single-user app)
  uploadedDate DateTime @default(now()) @map("uploaded_date")
  version      Int      @default(1)
  tags         String? // JSON array stored as string: ["policy", "audit"]
  isArchived   Boolean  @default(false) @map("is_archived")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([controlId])
  @@index([uploadedDate])
  @@index([fileType])
  @@map("evidence")
}

// ============================================================================
// POAMs (Plan of Action & Milestones)
// ============================================================================

model Poam {
  id                   Int       @id @default(autoincrement())
  controlId            Int       @map("control_id")
  gapDescription       String    @map("gap_description")
  remediationPlan      String    @map("remediation_plan")
  assignedTo           String?
  priority             String    @default("Medium") // High, Medium, Low
  status               String    @default("Open") // Open, In Progress, Completed, Risk Accepted
  startDate            DateTime? @map("start_date")
  targetCompletionDate DateTime? @map("target_completion_date")
  actualCompletionDate DateTime? @map("actual_completion_date")
  resourcesRequired    String?   @map("resources_required")
  budgetEstimate       Float?    @map("budget_estimate")
  riskAcceptanceNotes  String?   @map("risk_acceptance_notes")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  control    Control         @relation(fields: [controlId], references: [id], onDelete: Cascade)
  milestones PoamMilestone[]

  @@index([controlId])
  @@index([status])
  @@index([priority])
  @@map("poams")
}

// ============================================================================
// POAM Milestones
// ============================================================================

model PoamMilestone {
  id                   Int       @id @default(autoincrement())
  poamId               Int       @map("poam_id")
  milestoneDescription String    @map("milestone_description")
  dueDate              DateTime  @map("due_date")
  completionDate       DateTime? @map("completion_date")
  status               String    @default("Pending") // Pending, In Progress, Completed
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  poam Poam @relation(fields: [poamId], references: [id], onDelete: Cascade)

  @@index([poamId])
  @@index([status])
  @@map("poam_milestones")
}

// ============================================================================
// Microsoft 365 Policies
// ============================================================================

model M365Policy {
  id                Int      @id @default(autoincrement())
  policyType        String   @map("policy_type") // 'Intune' | 'Purview' | 'AzureAD'
  policyId          String   @unique @map("policy_id") // External ID from M365
  policyName        String   @map("policy_name")
  policyDescription String?  @map("policy_description")
  policyData        String   @map("policy_data") // JSON string of full policy object
  lastSynced        DateTime @default(now()) @map("last_synced")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  controlMappings ControlPolicyMapping[]

  @@map("m365_policies")
}

// ============================================================================
// Control to M365 Policy Mappings
// ============================================================================

model ControlPolicyMapping {
  id                Int      @id @default(autoincrement())
  controlId         Int      @map("control_id")
  policyId          Int      @map("policy_id")
  mappingConfidence String   @default("Medium") @map("mapping_confidence") // 'High' | 'Medium' | 'Low'
  mappingNotes      String?  @map("mapping_notes")
  mappedSettings    String?  @map("mapped_settings") // JSON array of settings that map to this control
  isAutoMapped      Boolean  @default(true) @map("is_auto_mapped") // True if auto-generated, false if manual
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  control Control    @relation(fields: [controlId], references: [id], onDelete: Cascade)
  policy  M365Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([controlId, policyId])
  @@index([isAutoMapped])
  @@map("control_policy_mappings")
}

// ============================================================================
// M365 Integration Settings
// ============================================================================

model M365Settings {
  id               Int       @id @default(autoincrement())
  tenantId         String?   @map("tenant_id")
  clientId         String?   @map("client_id")
  lastSyncDate     DateTime? @map("last_sync_date")
  syncEnabled      Boolean   @default(false) @map("sync_enabled")
  autoSyncInterval Int       @default(24) @map("auto_sync_interval") // hours
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("m365_settings")
}

// ============================================================================
// Sync History Log
// ============================================================================

model M365SyncLog {
  id              Int      @id @default(autoincrement())
  syncDate        DateTime @default(now()) @map("sync_date")
  syncType        String   @map("sync_type") // 'Manual' | 'Automatic'
  policiesUpdated Int      @default(0) @map("policies_updated")
  controlsUpdated Int      @default(0) @map("controls_updated")
  status          String   @map("status") // 'Success' | 'Failed' | 'Partial'
  errorMessage    String?  @map("error_message")
  syncDuration    Int?     @map("sync_duration") // milliseconds
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("m365_sync_logs")
}

// ============================================================================
// Change History / Audit Log
// ============================================================================

model ChangeHistory {
  id           Int      @id @default(autoincrement())
  controlId    Int      @map("control_id")
  fieldChanged String   @map("field_changed")
  oldValue     String?  @map("old_value")
  newValue     String?  @map("new_value")
  changedBy    String?  @map("changed_by") // Made optional for system changes
  changedAt    DateTime @default(now()) @map("changed_at")

  // Relations
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("change_history")
}

// ============================================================================
// Application Settings
// ============================================================================

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String // JSON-encoded value for flexibility
  category  String // m365, organization, preferences, system
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("settings")
}

// ============================================================================
// Report History
// ============================================================================

model ReportHistory {
  id          Int      @id @default(autoincrement())
  reportType  String   @map("report_type")
  reportName  String   @map("report_name")
  format      String
  filePath    String?  @map("file_path")
  fileSize    Int?     @map("file_size")
  filters     String? // JSON string of applied filters
  generatedAt DateTime @default(now()) @map("generated_at")
  generatedBy String?  @map("generated_by")
  status      String   @default("completed")

  @@map("report_history")
}

// ============================================================================
// Report Templates
// ============================================================================

model ReportTemplate {
  id          Int      @id @default(autoincrement())
  name        String
  reportType  String   @map("report_type")
  format      String
  filters     String? // JSON string of report filters
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("report_templates")
}

// ============================================================================
// Gap Analysis Tables
// ============================================================================

// Gap types for each control
model ControlGap {
  id                  Int      @id @default(autoincrement())
  controlId           Int      @map("control_id")
  control             Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Gap categorization
  gapType             String   @map("gap_type") // 'technical', 'policy', 'procedure', 'evidence'
  gapTitle            String   @map("gap_title")
  gapDescription      String   @map("gap_description")
  nistRequirement     String   @map("nist_requirement")
  severity            String   // 'critical', 'high', 'medium', 'low'

  // Remediation
  status              String   @default("open") // 'open', 'in_progress', 'resolved', 'accepted'
  remediationGuidance String   @map("remediation_guidance")
  assignedTo          String?  @map("assigned_to")
  dueDate             DateTime? @map("due_date")
  resolvedDate        DateTime? @map("resolved_date")
  notes               String?

  // Metadata
  source              String   @default("checklist") // 'checklist', 'manual', 'assessment'
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  poamItem            POAMItem?

  @@index([controlId])
  @@index([gapType])
  @@index([status])
  @@index([severity])
  @@map("control_gaps")
}

// Plan of Action & Milestones
model POAMItem {
  id                  Int      @id @default(autoincrement())
  controlId           Int      @map("control_id")
  control             Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Link to gap (optional - POA&M can exist without gap)
  gapId               Int?     @unique @map("gap_id")
  gap                 ControlGap? @relation(fields: [gapId], references: [id])

  // POA&M details
  weakness            String
  riskLevel           String   @map("risk_level") // 'critical', 'high', 'medium', 'low'
  likelihood          String   // 'high', 'medium', 'low'
  impact              String   // 'high', 'medium', 'low'

  // Remediation plan
  remediationPlan     String   @map("remediation_plan")
  requiredResources   String?  @map("required_resources")
  responsibleParty    String   @map("responsible_party")
  milestones          String   // JSON array of milestones

  // Tracking
  status              String   @default("open") // 'open', 'in_progress', 'closed'
  targetDate          DateTime @map("target_date")
  completionDate      DateTime? @map("completion_date")

  // Evidence
  evidence            String?

  // Metadata
  sourceOfFinding     String   @default("internal_assessment") @map("source_of_finding")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([controlId])
  @@index([status])
  @@index([riskLevel])
  @@index([targetDate])
  @@map("poam_items")
}

// Track control coverage metrics
model ControlCoverage {
  id                    Int      @id @default(autoincrement())
  controlId             Int      @unique @map("control_id")
  control               Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Coverage percentages (0-100)
  technicalCoverage     Int      @default(0) @map("technical_coverage")
  policyCoverage        Int      @default(0) @map("policy_coverage")
  proceduralCoverage    Int      @default(0) @map("procedural_coverage")
  evidenceCoverage      Int      @default(0) @map("evidence_coverage")
  overallCoverage       Int      @default(0) @map("overall_coverage")

  // Counts
  totalGaps             Int      @default(0) @map("total_gaps")
  criticalGaps          Int      @default(0) @map("critical_gaps")
  highGaps              Int      @default(0) @map("high_gaps")
  mediumGaps            Int      @default(0) @map("medium_gaps")
  lowGaps               Int      @default(0) @map("low_gaps")

  // Status
  complianceStatus      String   @default("unknown") @map("compliance_status") // 'compliant', 'partial', 'non_compliant', 'unknown'

  // Timestamps
  lastAssessed          DateTime @default(now()) @map("last_assessed")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([complianceStatus])
  @@index([overallCoverage])
  @@map("control_coverage")
}

// Evidence collection tracking
model ControlEvidence {
  id                  Int      @id @default(autoincrement())
  controlId           Int      @map("control_id")
  control             Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  // Evidence details
  evidenceType        String   @map("evidence_type") // 'policy', 'screenshot', 'log', 'report', 'procedure', 'other'
  evidenceTitle       String   @map("evidence_title")
  evidenceDescription String?  @map("evidence_description")

  // File information
  fileName            String?  @map("file_name")
  filePath            String?  @map("file_path")
  fileSize            Int?     @map("file_size")
  mimeType            String?  @map("mime_type")

  // Status
  status              String   @default("required") // 'required', 'uploaded', 'verified', 'rejected'
  uploadedBy          String?  @map("uploaded_by")
  verifiedBy          String?  @map("verified_by")

  // Timestamps
  uploadedAt          DateTime? @map("uploaded_at")
  verifiedAt          DateTime? @map("verified_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([controlId])
  @@index([status])
  @@index([evidenceType])
  @@map("control_evidence")
}

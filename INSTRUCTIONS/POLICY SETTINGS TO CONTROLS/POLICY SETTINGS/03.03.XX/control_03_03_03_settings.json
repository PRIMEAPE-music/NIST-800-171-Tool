{
  "controlId": "03.03.03",
  "controlTitle": "Audit Record Generation",
  "controlFamily": "AU",
  "settings": [
    {
      "id": "PV-AU-005",
      "settingName": "AuditLogRetentionPolicy",
      "displayName": "Microsoft 365 Audit Log Retention Policy",
      "settingPath": "RetentionDuration",
      "policyType": "Purview",
      "policySubType": "AuditRetention",
      "platform": "All",
      "dataType": "integer",
      "expectedValue": 365,
      "validationOperator": ">=",
      "description": "Configures audit log retention period to retain records for minimum 1 year (365 days). Default is 180 days for Audit Standard; E5 licenses support up to 10 years. Retention policies determine how long audit records are retained and searchable.",
      "implementationGuide": "1. Verify licensing (E5 or Audit add-on required for 1 year retention)\n2. Navigate to Microsoft Purview compliance portal > Audit > Retention policies\n3. Click '+ Create' to create new retention policy\n4. Configure policy settings:\n   - Name: 'NIST-Required-1Year-Retention'\n   - Record types: Select AzureActiveDirectory, Exchange, SharePoint, OneDrive\n   - Duration: 1 year (365 days minimum)\n   - Priority: 1 (highest)\n5. Review and create policy\n6. Verify with PowerShell: Get-UnifiedAuditLogRetentionPolicy | FL\n7. Note: Default retention for E5 users is 1 year for Exchange, SharePoint, Azure AD; 180 days for other services\n8. For extended retention beyond 1 year, use Azure Log Analytics workspace with custom retention",
      "microsoftDocUrl": "https://learn.microsoft.com/en-us/purview/audit-log-retention-policies",
      "controlMappings": [
        {
          "controlId": "03.03.03",
          "confidence": "High",
          "isRequired": true,
          "mappingRationale": "Audit log retention policies enforce the 'time period consistent with records retention policy' requirement by maintaining searchable audit records for organizational compliance periods. One year minimum retention aligns with most regulatory frameworks and enables historical investigations.",
          "nistRequirement": "Retain audit records for a time period consistent with the records retention policy (minimum 1 year recommended for NIST compliance)"
        }
      ]
    },
    {
      "id": "AZ-AU-005",
      "settingName": "LogAnalyticsRetention",
      "displayName": "Azure AD Log Analytics Workspace Retention",
      "settingPath": "properties.retentionInDays",
      "policyType": "AzureAD",
      "policySubType": "DiagnosticSettings",
      "platform": "All",
      "dataType": "integer",
      "expectedValue": 365,
      "validationOperator": ">=",
      "description": "Configures Log Analytics workspace retention for Azure AD audit and sign-in logs to retain data beyond the default 30-day portal retention. Recommended minimum 365 days for compliance. Supports retention up to 2 years (730 days) without additional cost tiers.",
      "implementationGuide": "1. Prerequisites: Azure subscription, Log Analytics workspace created\n2. Configure diagnostic settings to send to Log Analytics (if not done):\n   - Azure Portal > Azure AD > Diagnostic settings\n   - Enable AuditLogs and SignInLogs\n   - Select destination: Log Analytics workspace\n3. Configure retention in Log Analytics:\n   - Azure Portal > Log Analytics workspaces > Select workspace\n   - Settings > Usage and estimated costs > Data Retention\n   - Move slider to desired retention (365 days minimum)\n   - Click OK to save\n4. Verify retention: Workspace > General > Properties > Data Retention\n5. Alternative: Archive to Azure Storage Account for indefinite retention at lower cost\n6. Query retention settings: workspace | project RetentionInDays",
      "microsoftDocUrl": "https://learn.microsoft.com/en-us/azure/azure-monitor/logs/data-retention-archive",
      "controlMappings": [
        {
          "controlId": "03.03.03",
          "confidence": "High",
          "isRequired": true,
          "mappingRationale": "Log Analytics workspace retention extends Azure AD audit and sign-in log retention beyond default 30 days, enabling organizations to maintain identity and authentication audit records for compliance periods. This is critical as Azure AD portal only retains 30 days for P1/P2 licenses.",
          "nistRequirement": "Retain authentication and identity audit records consistent with organizational records retention policy"
        }
      ]
    },
    {
      "id": "PV-AU-006",
      "settingName": "MailboxAuditLogAgeLimit",
      "displayName": "Mailbox Audit Log Age Limit",
      "settingPath": "AuditLogAgeLimit",
      "policyType": "Purview",
      "policySubType": "MailboxAudit",
      "platform": "All",
      "dataType": "integer",
      "expectedValue": 180,
      "validationOperator": ">=",
      "description": "Configures retention period for mailbox audit logs. Default is 90 days; can be configured up to 180 days for mailbox-level retention. For longer retention, logs must be exported to unified audit log or external storage. CIS Benchmark recommends enabling with adequate retention.",
      "implementationGuide": "1. Check current mailbox audit retention:\n   Get-Mailbox -ResultSize Unlimited | Select UserPrincipalName,AuditLogAgeLimit\n2. Default retention varies by license:\n   - E3: 90 days\n   - E5: 180 days (via unified audit log)\n3. Mailbox audit records automatically flow to unified audit log\n4. For long-term retention beyond 180 days:\n   - Use unified audit log retention policies (up to 1 year default for E5)\n   - Configure Azure Log Analytics for extended retention\n   - Export to external SIEM or archive system\n5. Verify retention in unified audit log:\n   Search-UnifiedAuditLog -RecordType ExchangeItem -StartDate (Get-Date).AddDays(-180)\n6. Note: AuditLogAgeLimit is a mailbox-level setting; unified audit log provides central retention",
      "microsoftDocUrl": "https://learn.microsoft.com/en-us/microsoft-365/compliance/mailbox-auditing",
      "controlMappings": [
        {
          "controlId": "03.03.03",
          "confidence": "High",
          "isRequired": true,
          "mappingRationale": "Mailbox audit log retention ensures email-related audit records (access, modifications, deletions) are maintained per organizational retention policy. Integration with unified audit log enables centralized retention management and extended storage beyond mailbox-level limits.",
          "nistRequirement": "Generate and retain audit records for email system activities consistent with records retention policy"
        }
      ]
    },
    {
      "id": "AZ-AU-006",
      "settingName": "StorageAccountArchiving",
      "displayName": "Azure Storage Account Archive for Audit Logs",
      "settingPath": "properties.storageAccountId",
      "policyType": "AzureAD",
      "policySubType": "DiagnosticSettings",
      "platform": "All",
      "dataType": "string",
      "expectedValue": "configured",
      "validationOperator": "!=",
      "description": "Configures Azure Storage Account as archival destination for Azure AD audit and sign-in logs to support long-term retention (up to 10+ years) at low cost with immutable storage options. Ideal for regulatory compliance requiring multi-year retention.",
      "implementationGuide": "1. Create Azure Storage Account:\n   - Azure Portal > Storage accounts > + Create\n   - Select subscription, resource group, unique name\n   - Performance: Standard, Replication: LRS or GRS\n   - Enable hierarchical namespace for better organization\n2. Configure diagnostic settings for archival:\n   - Azure AD > Diagnostic settings > Add diagnostic setting\n   - Name: 'AzureAD-Archive-Long-Term'\n   - Select: AuditLogs, SignInLogs\n   - Destination: Archive to storage account\n   - Select storage account created above\n   - Retention: 0 (indefinite) or specific days\n3. Enable immutable storage (optional but recommended):\n   - Storage account > Data protection > Immutability policy\n   - Configure time-based retention policy\n4. Verify archival: Storage account > Containers > insights-logs-audit/signin\n5. Cost optimization: Configure lifecycle management to move old logs to Cool or Archive tier",
      "microsoftDocUrl": "https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/quickstart-azure-monitor-route-logs-to-storage-account",
      "controlMappings": [
        {
          "controlId": "03.03.03",
          "confidence": "High",
          "isRequired": true,
          "mappingRationale": "Azure Storage Account archiving provides cost-effective long-term retention for audit logs beyond standard retention periods. Immutable storage option ensures audit records cannot be modified or deleted before retention period expires, satisfying audit integrity requirements for extended compliance periods.",
          "nistRequirement": "Maintain audit records for extended periods consistent with organizational records retention policy, with optional immutability for audit integrity"
        }
      ]
    },
    {
      "id": "PV-AU-007",
      "settingName": "UnifiedAuditLogGeneration",
      "displayName": "Unified Audit Log Record Generation",
      "settingPath": "UnifiedAuditLogIngestionEnabled",
      "policyType": "Purview",
      "policySubType": "AuditConfiguration",
      "platform": "All",
      "dataType": "boolean",
      "expectedValue": true,
      "validationOperator": "==",
      "description": "Ensures the unified audit log actively generates audit records for selected event types from 03.03.01. This is the core setting that triggers actual audit record creation across all M365 services. Must remain enabled for continuous audit generation.",
      "implementationGuide": "1. Verify unified audit log is enabled and generating records:\n   Get-AdminAuditLogConfig | FL UnifiedAuditLogIngestionEnabled\n2. Test audit record generation:\n   - Perform a test action (e.g., create a document in SharePoint)\n   - Wait 30-60 minutes for record generation\n   - Search: Search-UnifiedAuditLog -StartDate (Get-Date).AddHours(-2) -EndDate (Get-Date) -ResultSize 50\n3. Verify records are being generated for key services:\n   - Azure AD: Search-UnifiedAuditLog -RecordType AzureActiveDirectory\n   - Exchange: Search-UnifiedAuditLog -RecordType ExchangeAdmin\n   - SharePoint: Search-UnifiedAuditLog -RecordType SharePoint\n   - Teams: Search-UnifiedAuditLog -RecordType MicrosoftTeams\n4. Monitor audit log health: Purview portal > Audit > Check for banners/warnings\n5. If no records generated, verify:\n   - Feature is enabled (may take 24 hours after enabling)\n   - User has appropriate license\n   - No audit bypass enabled for users",
      "microsoftDocUrl": "https://learn.microsoft.com/en-us/purview/audit-search",
      "controlMappings": [
        {
          "controlId": "03.03.03",
          "confidence": "High",
          "isRequired": true,
          "mappingRationale": "This setting directly satisfies the requirement to 'Generate audit records for the selected event types and audit record content specified in 03.03.01 and 03.03.02.' Without this enabled, no audit records are created regardless of other configurations.",
          "nistRequirement": "Generate audit records for the selected event types and audit record content specified in 03.03.01 and 03.03.02"
        }
      ]
    }
  ]
}
